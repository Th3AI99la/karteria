<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" data-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Completar Cadastro - Karteria</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
        <link rel="stylesheet" th:href="@{/css/karteria-colors.css}" />
        <link rel="stylesheet" th:href="@{/css/karteria-forms.css}" />
        <link rel="stylesheet" th:href="@{/css/pages/completar-cadastro.css}" />
        <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    </head>
    <body>
        <main class="form-container position-relative">
            <section class="form-card" data-aos="zoom-in" data-aos-duration="600" style="max-width: 700px">
                <button class="theme-toggle-form" id="themeToggle" aria-label="Alternar tema"><i class="fas fa-moon" id="themeIcon"></i></button>

                <header class="form-header" data-aos="fade-down" data-aos-delay="200">
                    <h1 class="form-title">Complete o Cadastro</h1>
                    <p class="form-subtitle">Quase lá! Precisamos de mais algumas informações.</p>
                    <p class="small text-muted" th:text="'Para a conta: ' + ${userEmail}"></p>
                </header>

                <div th:if="${#fields.hasErrors('${usuario.*}')}" class="alert alert-danger" data-aos="fade-in" data-aos-delay="300">Por favor, corrija os erros abaixo.</div>

                <form th:action="@{/completar-cadastro}" th:object="${usuario}" method="post" id="completeRegisterForm" data-aos="fade-up" data-aos-delay="400" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="nome" class="input-label">Nome:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-user"></i>
                                        <input type="text" id="nome" th:field="*{nome}" class="form-input" placeholder="Seu primeiro nome" autocomplete="given-name" required />
                                    </div>
                                </div>
                                <div th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}" class="error-message" style="display: block; padding-left: 0"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="sobrenome" class="input-label">Sobrenome:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-user"></i>
                                        <input
                                            type="text"
                                            id="sobrenome"
                                            th:field="*{sobrenome}"
                                            class="form-input"
                                            placeholder="Seu sobrenome"
                                            autocomplete="family-name"
                                            required />
                                    </div>
                                </div>
                                <div th:if="${#fields.hasErrors('sobrenome')}" th:errors="*{sobrenome}" class="error-message" style="display: block; padding-left: 0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="telefone" class="input-label">Telefone 1:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-phone"></i>
                                        <input
                                            type="tel"
                                            id="telefone"
                                            th:field="*{telefone}"
                                            class="form-input"
                                            placeholder="(XX) XXXXX-XXXX"
                                            autocomplete="tel-national"
                                            required />
                                    </div>
                                </div>
                                <div th:if="${#fields.hasErrors('telefone')}" th:errors="*{telefone}" class="error-message" style="display: block; padding-left: 0"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="telefone2" class="input-label">Telefone 2:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-phone"></i>
                                        <input type="tel" id="telefone2" th:field="*{telefone2}" class="form-input" placeholder="(Opcional)" autocomplete="tel-national" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <div class="form-row">
                            <label for="cpf" class="input-label">CPF:</label>
                            <div class="input-wrapper position-relative">
                                <i class="input-icon fas fa-id-card"></i>
                                <input type="text" id="cpf" th:field="*{cpf}" class="form-input" placeholder="000.000.000-00" required />
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('cpf')}" th:errors="*{cpf}" class="error-message" style="display: block; padding-left: 0"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="cep" class="input-label">CEP:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-mail-bulk"></i>
                                        <input type="text" id="cepInput" class="form-input" placeholder="00000-000" maxlength="9" required />
                                    </div>
                                </div>
                                <div class="error-message" id="cepError"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="rua" class="input-label">Rua:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-road"></i>
                                        <input type="text" id="ruaInput" class="form-input" placeholder="Será preenchido pelo CEP" required readonly />
                                    </div>
                                </div>
                                <div class="error-message" id="ruaError"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="numero" class="input-label">Número:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-hashtag"></i>
                                        <input type="text" id="numeroInput" class="form-input" placeholder="Nº" required />
                                    </div>
                                </div>
                                <div class="error-message" id="numeroError"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="complemento" class="input-label">Complemento:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-building"></i>
                                        <input type="text" id="complementoInput" class="form-input" placeholder="Apto, Bloco, Casa (Opcional)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-5">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="bairro" class="input-label">Bairro:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-map-signs"></i>
                                        <input type="text" id="bairroInput" class="form-input" placeholder="Será preenchido pelo CEP" required readonly />
                                    </div>
                                </div>
                                <div class="error-message" id="bairroError"></div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="cidade" class="input-label">Cidade:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-city"></i>
                                        <input type="text" id="cidadeInput" class="form-input" placeholder="Será preenchido pelo CEP" required readonly />
                                    </div>
                                </div>
                                <div class="error-message" id="cidadeError"></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group mb-3">
                                <div class="form-row">
                                    <label for="estado" class="input-label">UF:</label>
                                    <div class="input-wrapper position-relative">
                                        <i class="input-icon fas fa-flag"></i>
                                        <input type="text" id="estadoInput" class="form-input" placeholder="UF" required readonly />
                                    </div>
                                </div>
                                <div class="error-message" id="estadoError"></div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="enderecoCompleto" th:field="*{endereco}" />

                    <div class="input-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="termsComplete" required />
                            <label class="form-check-label text-muted" for="termsComplete">
                                Confirmo que li e concordo com os
                                <a href="#" class="form-link primary" target="_blank" rel="noopener noreferrer">Termos de Uso</a>
                                e
                                <a href="#" class="form-link primary" target="_blank" rel="noopener noreferrer">Política de Privacidade</a>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="form-button mb-3" id="submitCompleteButton">
                        <i class="fas fa-check-circle me-2"></i>
                        Finalizar Cadastro
                    </button>

                    <div class="text-center">
                        <a th:href="@{/logout}" class="form-link">Cancelar e Sair</a>
                    </div>
                </form>
            </section>
        </main>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
        <script th:src="@{/js/karteria-forms.js}"></script>
        <script>
            AOS.init({ once: true });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const cepInput = document.getElementById("cepInput");
                const ruaInput = document.getElementById("ruaInput");
                const bairroInput = document.getElementById("bairroInput");
                const cidadeInput = document.getElementById("cidadeInput");
                const estadoInput = document.getElementById("estadoInput");
                const numeroInput = document.getElementById("numeroInput"); // Para focar após CEP
                const complementoInput = document.getElementById("complementoInput");
                const enderecoCompletoHidden = document.getElementById("enderecoCompleto"); // Campo hidden
                const cepErrorDiv = document.getElementById("cepError");

                if (cepInput && ruaInput && bairroInput && cidadeInput && estadoInput && numeroInput && enderecoCompletoHidden) {
                    // Função para limpar campos do endereço
                    const limparCamposEndereco = (clearCep = false) => {
                        if (clearCep) cepInput.value = "";
                        ruaInput.value = "";
                        bairroInput.value = "";
                        cidadeInput.value = "";
                        estadoInput.value = "";
                        complementoInput.value = ""; // Limpa complemento também
                        cepErrorDiv.textContent = "";
                        cepInput.closest(".input-group").classList.remove("error");
                        // Limpa campo hidden
                        if (enderecoCompletoHidden) enderecoCompletoHidden.value = "";
                    };

                    // Função para preencher campos e atualizar o campo hidden
                    const preencherCampos = (dados) => {
                        if (dados.erro) {
                            limparCamposEndereco();
                            cepErrorDiv.textContent = "CEP não encontrado.";
                            cepInput.closest(".input-group").classList.add("error");
                            return;
                        }
                        ruaInput.value = dados.logradouro || "";
                        bairroInput.value = dados.bairro || "";
                        cidadeInput.value = dados.localidade || "";
                        estadoInput.value = dados.uf || "";
                        cepErrorDiv.textContent = "";
                        cepInput.closest(".input-group").classList.remove("error");
                        // Foca no campo número após preencher
                        numeroInput.focus();
                        atualizarEnderecoCompleto(); // Atualiza o campo hidden
                    };

                    // Função para buscar na API ViaCEP
                    const buscarCep = async (cep) => {
                        const cepLimpo = cep.replace(/\D/g, ""); // Remove não-dígitos
                        if (cepLimpo.length !== 8) {
                            // Não faz nada se não tiver 8 dígitos
                            // Poderia limpar os campos se o CEP ficar inválido
                            // limparCamposEndereco();
                            return;
                        }

                        const url = `https://viacep.com.br/ws/${cepLimpo}/json/`;
                        console.log(`Buscando CEP: ${cepLimpo}`); // Log

                        try {
                            const response = await fetch(url);
                            if (!response.ok) {
                                throw new Error("Erro ao buscar CEP");
                            }
                            const dados = await response.json();
                            console.log("Dados recebidos:", dados); // Log
                            preencherCampos(dados);
                        } catch (error) {
                            console.error("Falha na API ViaCEP:", error);
                            limparCamposEndereco();
                            cepErrorDiv.textContent = "Erro ao buscar CEP. Verifique a conexão.";
                            cepInput.closest(".input-group").classList.add("error");
                        }
                    };

                    // Função para montar o endereço completo no campo hidden
                    const atualizarEnderecoCompleto = () => {
                        if (!enderecoCompletoHidden) return;
                        const partes = [
                            ruaInput.value,
                            numeroInput.value ? `, ${numeroInput.value}` : "", // Adiciona número se houver
                            complementoInput.value ? ` - ${complementoInput.value}` : "", // Adiciona complemento se houver
                            bairroInput.value ? ` - ${bairroInput.value}` : "",
                            cidadeInput.value || "",
                            estadoInput.value ? `/${estadoInput.value}` : "",
                            cepInput.value ? ` (CEP: ${cepInput.value})` : ""
                        ];
                        // Filtra partes vazias e junta
                        enderecoCompletoHidden.value = partes.filter((p) => p && p.trim() !== "").join("");
                        console.log("Endereço Completo (hidden):", enderecoCompletoHidden.value); // Log
                    };

                    // Adiciona máscara simples e listener ao campo CEP
                    let debounceTimer;
                    cepInput.addEventListener("input", (event) => {
                        // Máscara XXXXX-XXX
                        let value = event.target.value.replace(/\D/g, "");
                        value = value.replace(/^(\d{5})(\d)/, "$1-$2");
                        event.target.value = value.substring(0, 9); // Limita a 9 caracteres

                        // Debounce para a busca
                        clearTimeout(debounceTimer);
                        if (event.target.value.replace(/\D/g, "").length === 8) {
                            debounceTimer = setTimeout(() => buscarCep(event.target.value), 500); // Espera 500ms
                        } else {
                            // Se o CEP ficar inválido após preenchido, limpa os campos dependentes
                            if (ruaInput.value !== "") {
                                limparCamposEndereco(false); // Não limpa o próprio CEP
                            }
                        }
                    });

                    // Adiciona listeners aos campos Número e Complemento para atualizar o endereço hidden
                    numeroInput.addEventListener("input", atualizarEnderecoCompleto);
                    complementoInput.addEventListener("input", atualizarEnderecoCompleto);
                    // Também atualiza se o CEP mudar (caso a busca falhe ou seja corrigida)
                    cepInput.addEventListener("change", atualizarEnderecoCompleto);
                } else {
                    console.error("Erro: Um ou mais campos de endereço não foram encontrados.");
                }
            });
        </script>
    </body>
</html>
